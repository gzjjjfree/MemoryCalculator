name: Cross Platform Release

on:
  push:
    tags:
      - "v*" # 当推送 v1.0.0 等标签时触发
  workflow_dispatch: #

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Set up Java
        # 签名工具 apksigner 需要 Java 环境
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Fyne CLI
        # 使用你本地成功的 fyne 命令工具
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build Android (Native Mode)
        env:
          K_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          K_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          K_ALIAS: "memory-calc-alias"
        run: |
          # 1. 还原 Keystore
          echo "$K_BASE64" | base64 -d > release.keystore
          
          # 3. 设置 Android 环境变量
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export ANDROID_NDK_HOME=$(ls -d $ANDROID_SDK_ROOT/ndk/* | tail -1)

          # 4. 使用 release 命令进行正式打包
          # 注意：这里改成了 release，并且参数名在 release 下是有效的
          fyne release -os android/arm64 \
            -appID com.gzjjj.memorycalculator \
            -icon Icon.png \
            -keyStore release.keystore \
            -keystore-pass "$K_PASS" \
            -key-pass "$K_PASS" \
            -name MemoryCalculator

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: fyne-cross/dist/android-arm64/*.apk

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install Fyne CLI
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build macOS (ARM64)
        run: |
          # macOS 环境下直接使用 fyne package 编译 arm64
          # 如果需要发布，建议在此处进行签名
          fyne package -os darwin -name MemoryCalculator -icon Icon.png
          # 压缩为 zip 方便下载
          zip -r MemoryCalculator_macOS_arm64.zip MemoryCalculator.app

      - name: Upload macOS App
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: "*.zip"

  create-release:
    needs: [build-android, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android-apk/*.apk
            macos-app/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
