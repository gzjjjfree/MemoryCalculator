name: Cross Platform Release

on:
  push:
    tags:
      - "v*" # 当推送 v1.0.0 等标签时触发
  workflow_dispatch: #

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Set up Java
        # 签名工具 apksigner 需要 Java 环境
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Fyne CLI
        # 使用你本地成功的 fyne 命令工具
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build Android (Native Mode)
        env:
          K_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          K_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          K_ALIAS: "memory-calc-alias"
        run: |
          # 2. 下载并安装 bundletool (解决报错核心)
          # 2. 手动下载 bundletool (Google 官方)
          BT_VERSION="1.17.0"
          curl -L -o bundletool.jar https://github.com/google/bundletool/releases/download/${BT_VERSION}/bundletool-all-${BT_VERSION}.jar

          # 3. 创建一个命令脚本，让 fyne 能够通过 "bundletool" 这个名字调用它
          # 使用 printf 确保换行和内容准确，添加 #!/bin/bash
          printf "#!/bin/bash\njava -jar $(pwd)/bundletool.jar \"\$@\"" > bundletool
          chmod +x bundletool
          export PATH=$PATH:$(pwd)
          
          # 验证 bundletool 是否可用
          ./bundletool version

          # 1. 还原 Keystore
          echo "$K_BASE64" | base64 -d > release.keystore

          # 如果 RAW_VERSION 看起来不像版本号（比如是 main 或 master），则设为 0.0.1
          if [[ $RAW_VERSION =~ ^v?[0-9] ]]; then
            CLEAN_VERSION=$(echo $RAW_VERSION | sed 's/^v//')
          else
            CLEAN_VERSION="0.0.1"
          fi
          # 4. 获取 Build ID (appBuild)
          # 使用 GitHub 的运行次数作为版本代码，确保它是递增的正整数
          BUILD_ID=${{ github.run_number }}
          
          echo "Final App Version: $CLEAN_VERSION"
          echo "Final Build ID: $BUILD_ID"
          
          # 3. 设置 Android 环境变量
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export ANDROID_NDK_HOME=$(ls -d $ANDROID_SDK_ROOT/ndk/* | tail -1)

          # 4. 使用 release 命令进行正式打包
          # 注意：这里改成了 release，并且参数名在 release 下是有效的
          fyne release -os android/arm64 \
            -appID com.gzjjj.memorycalculator \
            -icon Icon.png \
            -keyStore release.keystore \
            -keyStorePass "$K_PASS" \
            -keyPass "$K_PASS" \
            -appVersion "$CLEAN_VERSION" \
            -appBuild "$BUILD_ID" \
            -keyName "$K_ALIAS" \
            -name MemoryCalculator

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: fyne-cross/dist/android-arm64/*.apk

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install Fyne CLI
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build macOS (ARM64)
        run: |
          # macOS 环境下直接使用 fyne package 编译 arm64
          # 如果需要发布，建议在此处进行签名
          fyne package -os darwin -name MemoryCalculator -icon Icon.png
          # 压缩为 zip 方便下载
          zip -r MemoryCalculator_macOS_arm64.zip MemoryCalculator.app

      - name: Upload macOS App
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: "*.zip"

  create-release:
    needs: [build-android, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android-apk/*.apk
            macos-app/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
