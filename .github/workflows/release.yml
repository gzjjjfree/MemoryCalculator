name: Cross Platform Release

on:
  push:
    tags:
      - "v*" # 当推送 v1.0.0 等标签时触发
  workflow_dispatch: #

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build Android (ARM64)
        env:
          # 使用环境变量传递 Secret，这是最安全的方式，防止 shell 解析特殊字符
          K_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          K_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          K_ALIAS: "memory-calc-alias" # 填入你 keytool 查出来的别名
        run: |
          # 1. 安装最新版工具
          go install github.com/fyne-io/fyne-cross@latest
          
          # 2. 还原 Keystore 并确保权限正确
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          if [ ! -s release.keystore ]; then echo "Keystore is empty!"; exit 1; fi

          chmod 644 release.keystore
          
          # 1. 检查文件大小，确保 base64 转换没问题
          ls -lh release.keystore
          # 3. 运行构建
          # 注意：密码通过变量传递，避免直接写在命令行字符串中
          fyne-cross android \
            --debug \
            --pull \
            --release \
            --keystore release.keystore \
            --keystore-pass "$K_PASS" \
            --key-pass "$K_PASS" \
            --key-name "$K_ALIAS" \
            --arch arm64 \
            --app-id com.gzjjj.memorycalculator \
            --icon Icon.png \
            --no-cache # 确保不使用旧的容器残余

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: fyne-cross/dist/android-arm64/*.apk

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install Fyne CLI
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build macOS (ARM64)
        run: |
          # macOS 环境下直接使用 fyne package 编译 arm64
          # 如果需要发布，建议在此处进行签名
          fyne package -os darwin -name MemoryCalculator -icon Icon.png
          # 压缩为 zip 方便下载
          zip -r MemoryCalculator_macOS_arm64.zip MemoryCalculator.app

      - name: Upload macOS App
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: "*.zip"

  create-release:
    needs: [build-android, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android-apk/*.apk
            macos-app/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
