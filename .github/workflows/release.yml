name: Cross Platform Release

on:
  push:
    tags:
      - "v*" # 当推送 v1.0.0 等标签时触发
  workflow_dispatch: #

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Set up Java
        # 签名工具 apksigner 需要 Java 环境
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install Fyne CLI
        # 使用你本地成功的 fyne 命令工具
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build Android (Native Mode)
        env:
          K_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          K_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          K_ALIAS: "memory-calc-alias"
        run: |
          RAW_VERSION=${GITHUB_REF#refs/tags/}
          # 2. 下载并安装 bundletool (解决报错核心)
          # 2. 手动下载 bundletool (Google 官方)
          BT_VERSION="1.17.0"
          curl -L -o bundletool.jar https://github.com/google/bundletool/releases/download/${BT_VERSION}/bundletool-all-${BT_VERSION}.jar

          # 3. 创建一个命令脚本，让 fyne 能够通过 "bundletool" 这个名字调用它
          # 使用 printf 确保换行和内容准确，添加 #!/bin/bash
          printf "#!/bin/bash\njava -jar $(pwd)/bundletool.jar \"\$@\"" > bundletool
          chmod +x bundletool
          export PATH=$PATH:$(pwd)

          # 验证 bundletool 是否可用
          ./bundletool version

          # 1. 还原 Keystore
          echo "$K_BASE64" | base64 -d > release.keystore

          # 如果 RAW_VERSION 看起来不像版本号（比如是 main 或 master），则设为 0.0.1
          if [[ $RAW_VERSION =~ ^v?[0-9] ]]; then
            CLEAN_VERSION=$(echo $RAW_VERSION | sed 's/^v//')
          else
            CLEAN_VERSION="0.0.1"
          fi
          # 4. 获取 Build ID (appBuild)
          # 使用 GitHub 的运行次数作为版本代码，确保它是递增的正整数
          BUILD_ID=${{ github.run_number }}

          echo "Final App Version: $CLEAN_VERSION"
          echo "Final Build ID: $BUILD_ID"

          # 3. 设置 Android 环境变量
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export ANDROID_NDK_HOME=$(ls -d $ANDROID_SDK_ROOT/ndk/* | tail -1)

          # 4. 使用 release 命令进行正式打包
          # 注意：这里改成了 release，并且参数名在 release 下是有效的
          fyne release -os android/arm64 \
            -appID com.gzjjj.memorycalculator \
            -icon Icon.png \
            -keyStore release.keystore \
            -keyStorePass "$K_PASS" \
            -keyPass "$K_PASS" \
            -appVersion "$CLEAN_VERSION" \
            -appBuild "$BUILD_ID" \
            -keyName "$K_ALIAS" \
            -name MemoryCalculator
            
            # 使用 bundletool 生成包含通用 APK 的 apks 压缩包
            ./bundletool build-apks --bundle=MemoryCalculator.aab --output=MemoryCalculator.apks --mode=universal --ks=release.keystore --ks-pass=pass:"$K_PASS" --ks-key-alias="$K_ALIAS" --key-pass=pass:"$K_PASS"

            # 从 .apks 中提取出真正的 .apk 文件
            unzip -p MemoryCalculator.apks universal.apk > MemoryCalculator_Native.apk

            echo "Success! MemoryCalculator.apk has been generated."

            # 重命名 APK 和 AAB，增加 _Native 后缀
            mv MemoryCalculator.aab MemoryCalculator_Native.aab

            echo "Success! Native artifacts renamed."

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            *.apk
            *.aab

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install Fyne CLI
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build macOS (ARM64)
        run: |
          # macOS 环境下直接使用 fyne package 编译 arm64
          # 如果需要发布，建议在此处进行签名
          fyne package -os darwin -name MemoryCalculator -icon Icon.png
          # 压缩为 zip 方便下载
          zip -r MemoryCalculator_macOS_arm64.zip MemoryCalculator.app

      - name: Upload macOS App
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: "*.zip"

  build-docker:
    runs-on: ubuntu-latest

    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 初始化 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: 3. 安装 fyne-cross 工具
        # 对应你本地的 go install ...
        run: go install github.com/fyne-io/fyne-cross@latest

      - name: 4. 准备签名文件 (Keystore)
        # 将你的 Secret 还原为本地文件，以便 Docker 能够读取
        env:
          K_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          docker pull fyneio/fyne-cross-images:android
          RAW_VERSION=${GITHUB_REF#refs/tags/}
          # 如果 RAW_VERSION 看起来不像版本号（比如是 main 或 master），则设为 0.0.1
          if [[ $RAW_VERSION =~ ^v?[0-9] ]]; then
            CLEAN_VERSION=$(echo $RAW_VERSION | sed 's/^v//')
          else
            CLEAN_VERSION="0.0.1"
          fi
          echo "$K_BASE64" | base64 -d > release.keystore

      - name: 5. 执行 fyne-cross 构建 (核心对照项)
        # 这里模拟你本地 Docker 运行的完整命令
        # 注意：使用 --debug 可以看到最底层的 Docker 指令
        env:
          K_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          K_ALIAS: "memory-calc-alias"
        run: |
          fyne-cross android \
            --debug \
            --arch arm64 \
            --app-id com.gzjjj.memorycalculator \
            --icon Icon.png \
            --keystore release.keystore \
            --keystore-pass "$K_PASS" \
            --key-pass "$K_PASS" \
            --key-name "$K_ALIAS" \
            --name MemoryCalculator \
            --app-version "$CLEAN_VERSION" \
            --app-build ${{ github.run_number }}

      - name: 6. 检查构建产物 (对照本地 fyne-cross/dist 目录)
        run: |
          echo "检查构建输出目录："
          ls -R fyne-cross/dist/

      - name: 7. 上传生成的 APK
        uses: actions/upload-artifact@v4
        with:
          name: docker-build-apk
          # fyne-cross 默认会将产物放在这个深度目录下
          path: fyne-cross/dist/android-arm64/MemoryCalculator.apk

  create-release:
    needs: [build-android, build-macos, build-docker]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Organize and Rename Assets
        run: |
          # 1. 准备发布目录
          mkdir -p release_assets

          # 2. 处理 Docker 版 (精简版 10MB)
          # 我们给它一个非常明确的名字
          cp docker-build-apk/MemoryCalculator.apk release_assets/MemoryCalculator_docker.apk

          # 3. 处理 Native 版 (通用版 23MB)
          # 如果你依然想保留它作为备选
          cp android-apk/MemoryCalculator_Native.apk release_assets/MemoryCalculator.apk
          cp android-apk/MemoryCalculator_Native.aab release_assets/MemoryCalculator.aab

          # 4. 处理 macOS 版
          cp macos-app/*.zip release_assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
